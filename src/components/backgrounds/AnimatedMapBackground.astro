---
// Animated Map Background - Astro Component
// Renders canvas-based topographic terrain animation
// Automatically switches between light and dark mode
---

<div class="animated-map-bg fixed inset-0 pointer-events-none" aria-hidden="true">
  <canvas id="map-bg-canvas" class="w-full h-full"></canvas>
</div>

<script>
  function initMapBackground() {
    const canvas = document.getElementById('map-bg-canvas') as HTMLCanvasElement;
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    let animationId: number;

    const resize = () => {
      const dpr = window.devicePixelRatio || 1;
      canvas.width = window.innerWidth * dpr;
      canvas.height = window.innerHeight * dpr;
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
      ctx.scale(dpr, dpr);
    };

    resize();
    window.addEventListener('resize', resize);

    // Check if dark mode
    const isDark = () => document.documentElement.classList.contains('dark');

    // Light mode terrain layers
    const lightTerrainLayers = [
      { baseY: 0.92, amplitude: 90, frequency: 0.0018, speed: 0.035, phase: 0, color: 'rgba(34, 197, 94, 0.09)' },
      { baseY: 0.82, amplitude: 75, frequency: 0.002, speed: 0.04, phase: 0.8, color: 'rgba(22, 163, 74, 0.08)' },
      { baseY: 0.72, amplitude: 65, frequency: 0.0025, speed: 0.05, phase: 1.6, color: 'rgba(21, 128, 61, 0.07)' },
      { baseY: 0.60, amplitude: 55, frequency: 0.003, speed: 0.055, phase: 2.4, color: 'rgba(15, 118, 55, 0.065)' },
      { baseY: 0.48, amplitude: 48, frequency: 0.0028, speed: 0.05, phase: 3.2, color: 'rgba(180, 165, 140, 0.07)' },
      { baseY: 0.38, amplitude: 42, frequency: 0.0022, speed: 0.045, phase: 4.0, color: 'rgba(168, 162, 158, 0.06)' },
      { baseY: 0.28, amplitude: 38, frequency: 0.0032, speed: 0.06, phase: 4.8, color: 'rgba(140, 135, 125, 0.055)' },
      { baseY: 0.18, amplitude: 32, frequency: 0.0035, speed: 0.065, phase: 5.6, color: 'rgba(107, 116, 85, 0.05)' },
    ];

    // Dark mode terrain layers - all using bright teal-green, fading opacity toward top
    const darkTerrainLayers = [
      { baseY: 0.92, amplitude: 90, frequency: 0.0018, speed: 0.035, phase: 0, color: 'rgba(45, 212, 191, 0.12)' },   // teal-400
      { baseY: 0.82, amplitude: 75, frequency: 0.002, speed: 0.04, phase: 0.8, color: 'rgba(45, 212, 191, 0.10)' },   // teal-400
      { baseY: 0.72, amplitude: 65, frequency: 0.0025, speed: 0.05, phase: 1.6, color: 'rgba(45, 212, 191, 0.08)' },  // teal-400
      { baseY: 0.60, amplitude: 55, frequency: 0.003, speed: 0.055, phase: 2.4, color: 'rgba(45, 212, 191, 0.07)' },  // teal-400
      { baseY: 0.48, amplitude: 48, frequency: 0.0028, speed: 0.05, phase: 3.2, color: 'rgba(45, 212, 191, 0.06)' },  // teal-400
      { baseY: 0.38, amplitude: 42, frequency: 0.0022, speed: 0.045, phase: 4.0, color: 'rgba(45, 212, 191, 0.05)' }, // teal-400
      { baseY: 0.28, amplitude: 38, frequency: 0.0032, speed: 0.06, phase: 4.8, color: 'rgba(45, 212, 191, 0.04)' },  // teal-400
      { baseY: 0.18, amplitude: 32, frequency: 0.0035, speed: 0.065, phase: 5.6, color: 'rgba(45, 212, 191, 0.03)' }, // teal-400
    ];

    // Contour lines config
    const createContourLines = (dark: boolean) =>
      Array.from({ length: 14 }, (_, i) => ({
        y: 0.08 + i * 0.065,
        amplitude: 10 + i * 4,
        frequency: 0.003 + i * 0.0003,
        speed: 0.03 + i * 0.007,
        phase: i * 0.6,
        opacity: dark ? 0.025 + i * 0.008 : 0.03 + i * 0.006,
      }));

    type TerrainLayer = typeof lightTerrainLayers[0];
    type ContourLine = ReturnType<typeof createContourLines>[0];

    const drawTerrainLayer = (layer: TerrainLayer, time: number) => {
      const width = window.innerWidth;
      const height = window.innerHeight;
      const { baseY, amplitude, frequency, speed, phase, color } = layer;

      ctx.beginPath();
      ctx.moveTo(0, height);

      for (let x = 0; x <= width; x += 2) {
        const y =
          height * baseY +
          Math.sin(x * frequency + time * speed + phase) * amplitude +
          Math.sin(x * frequency * 0.6 + time * speed * 0.8 + phase * 1.3) * amplitude * 0.4 +
          Math.sin(x * frequency * 0.35 + time * speed * 0.5 + phase * 0.7) * amplitude * 0.25;
        ctx.lineTo(x, y);
      }

      ctx.lineTo(width, height);
      ctx.closePath();

      // Gradient for terrain depth
      const gradient = ctx.createLinearGradient(0, height * baseY - amplitude, 0, height);
      const baseOpacity = parseFloat(color.match(/[\d.]+\)$/)?.[0].replace(')', '') || '0');

      gradient.addColorStop(0, color);
      gradient.addColorStop(0.35, color.replace(/[\d.]+\)$/, (baseOpacity * 1.6) + ')'));
      gradient.addColorStop(0.7, color.replace(/[\d.]+\)$/, (baseOpacity * 0.8) + ')'));
      gradient.addColorStop(1, color.replace(/[\d.]+\)$/, (baseOpacity * 0.3) + ')'));

      ctx.fillStyle = gradient;
      ctx.fill();
    };

    const drawContourLine = (line: ContourLine, time: number, dark: boolean) => {
      const width = window.innerWidth;
      const height = window.innerHeight;
      const { y, amplitude, frequency, speed, phase, opacity } = line;

      ctx.beginPath();

      for (let x = 0; x <= width; x += 3) {
        const yPos =
          height * y +
          Math.sin(x * frequency + time * speed + phase) * amplitude +
          Math.sin(x * frequency * 0.5 + time * speed * 0.6 + phase) * amplitude * 0.3;

        if (x === 0) {
          ctx.moveTo(x, yPos);
        } else {
          ctx.lineTo(x, yPos);
        }
      }

      // Different contour colors for light/dark mode
      // Dark: teal to complement slate, Light: warm brown
      ctx.strokeStyle = dark
        ? `rgba(20, 184, 166, ${opacity})`  // teal-500 - cool blue-green
        : `rgba(130, 120, 110, ${opacity})`;
      ctx.lineWidth = 0.9;
      ctx.stroke();
    };

    const drawGrid = (dark: boolean) => {
      const width = window.innerWidth;
      const height = window.innerHeight;
      const gridSize = 100;

      // Teal grid for dark mode, warm for light
      ctx.strokeStyle = dark ? 'rgba(20, 184, 166, 0.03)' : 'rgba(140, 130, 120, 0.04)';
      ctx.lineWidth = 0.6;

      for (let x = 0; x < width; x += gridSize) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
      }

      for (let y = 0; y < height; y += gridSize) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
      }
    };

    let startTime: number | null = null;

    const animate = (timestamp: number) => {
      if (!startTime) startTime = timestamp;
      const time = (timestamp - startTime) / 1000;
      const dark = isDark();

      const width = window.innerWidth;
      const height = window.innerHeight;

      // Background gradient
      const bgGradient = ctx.createRadialGradient(
        width * 0.25, height * 0.25, 0,
        width * 0.5, height * 0.5, width * 0.9
      );

      if (dark) {
        // Using Tailwind slate (cool blue-grey) for dark mode
        bgGradient.addColorStop(0, '#0f172a');   // slate-900
        bgGradient.addColorStop(0.3, '#1e293b'); // slate-800
        bgGradient.addColorStop(0.6, '#1e293b'); // slate-800
        bgGradient.addColorStop(1, '#0f172a');   // slate-900
      } else {
        bgGradient.addColorStop(0, '#FAFAF9');
        bgGradient.addColorStop(0.25, '#F8F7F5');
        bgGradient.addColorStop(0.5, '#F5F5F4');
        bgGradient.addColorStop(0.75, '#F3F2F0');
        bgGradient.addColorStop(1, '#EFEEEC');
      }

      ctx.fillStyle = bgGradient;
      ctx.fillRect(0, 0, width, height);

      // Draw layers
      const terrainLayers = dark ? darkTerrainLayers : lightTerrainLayers;
      const contourLines = createContourLines(dark);

      drawGrid(dark);
      terrainLayers.forEach((layer) => drawTerrainLayer(layer, time));
      contourLines.forEach((line) => drawContourLine(line, time, dark));

      animationId = requestAnimationFrame(animate);
    };

    animationId = requestAnimationFrame(animate);

    // Cleanup
    return () => {
      window.removeEventListener('resize', resize);
      cancelAnimationFrame(animationId);
    };
  }

  // Initialize on page load and after view transitions
  document.addEventListener('DOMContentLoaded', initMapBackground);
  document.addEventListener('astro:page-load', initMapBackground);
</script>
